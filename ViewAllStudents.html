<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل الطلاب | جامعة 6 أكتوبر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .o6u-blue { background-color: #1a237e; }
        .o6u-text { color: #1a237e; }
        .glass-header {
            background: rgba(26, 35, 126, 0.98);
            backdrop-filter: blur(10px);
        }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="min-h-screen pb-10">

    <nav class="glass-header text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e0/O6U_Logo.png" alt="O6U Logo" class="w-12 h-12 bg-white rounded-full p-1 border-2 border-indigo-200">
                <div>
                    <h1 class="text-xl font-bold">نظام سجلات الطلاب</h1>
                    <p class="text-xs text-indigo-300">جامعة 6 أكتوبر - إدارة الشؤون</p>
                </div>
            </div>
            <a href="Insert-Student.html" class="bg-indigo-50 text-indigo-900 px-6 py-2 rounded-full font-bold text-sm hover:bg-white transition-all transform hover:scale-105">
                + تسجيل طالب جديد
            </a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 mt-8">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-6 rounded-3xl card-shadow">
            <div>
                <h2 class="text-2xl font-extrabold o6u-text">قائمة الطلاب</h2>
                <p class="text-gray-500 text-sm">يمكنك البحث، تعديل، أو حذف بيانات الطلاب المسجلين</p>
            </div>
            <div class="relative w-full md:w-96">
                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ابحث بالاسم أو الكلية..." 
                       class="w-full pr-12 pl-4 py-3 bg-gray-50 border border-gray-100 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                <svg class="w-6 h-6 text-gray-400 absolute right-4 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <div class="bg-white rounded-3xl overflow-hidden card-shadow">
            <div class="overflow-x-auto">
                <table class="w-full text-right" id="studentsTable">
                    <thead>
                        <tr class="bg-gray-50 text-indigo-900 border-b border-gray-100">
                            <th class="px-6 py-5 font-bold text-sm">اسم الطالب</th>
                            <th class="px-6 py-5 font-bold text-sm">الكلية</th>
                            <th class="px-6 py-5 font-bold text-sm">المستوى</th>
                            <th class="px-6 py-5 font-bold text-sm">رقم الهاتف</th>
                            <th class="px-6 py-5 font-bold text-sm text-center">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-50">
                        <tr id="loadingRow">
                            <td colspan="5" class="px-6 py-20 text-center">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-800"></div>
                                    <span class="text-gray-500 font-bold">جاري تحميل البيانات...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="o6u-blue p-5 text-white flex justify-between items-center">
                <h3 class="font-bold">تعديل بيانات الطالب</h3>
                <button onclick="closeModal()" class="text-2xl">&times;</button>
            </div>
            <form id="editForm" class="p-6 space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">الاسم بالكامل</label>
                    <input type="text" id="edit-name" required class="w-full px-4 py-2 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">الكلية</label>
                        <input type="text" id="edit-faculty" required class="w-full px-4 py-2 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">المستوى</label>
                        <input type="text" id="edit-level" required class="w-full px-4 py-2 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 o6u-blue text-white font-bold py-3 rounded-xl shadow-lg">حفظ التعديلات</button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- روابط n8n (تأكدي أن الـ Webhooks مفعلة) ---
        const GET_URL = 'https://v2-n8n.veemi.site/webhook/GetALLStudents';
        const DELETE_URL = 'https://v2-n8n.veemi.site/webhook/DeleteStudent';
        const UPDATE_URL = 'https://v2-n8n.veemi.site/webhook/UpdateStudents';
      

        async function fetchStudents() {
            try {
                const response = await fetch(GET_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const students = await response.json();
                
                const tableBody = document.getElementById('tableBody');
                document.getElementById('loadingRow').remove();

                students.forEach(std => {
                    const fields = std.fields || std;
                    const id = std.id;
                    
                    // تنظيف النصوص من أي علامات قد تعطل الأزرار
                    const cleanName = (fields.fullName || '-').replace(/'/g, "\\'");
                    const cleanFaculty = (fields.faculty || '-').replace(/'/g, "\\'");
                    const cleanLevel = (fields.AcadamicYear || '-').replace(/'/g, "\\'");

                    const row = document.createElement('tr');
                    row.className = "hover:bg-indigo-50/30 transition-all border-b border-gray-50";
                    row.innerHTML = `
                        <td class="px-6 py-4 font-bold text-gray-800">${fields.fullName || '-'}</td>
                        <td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-bold">${fields.faculty || '-'}</span></td>
                        <td class="px-6 py-4 text-gray-600 font-medium">${fields.AcadamicYear || '-'}</td>
                        <td class="px-6 py-4 text-gray-400 font-mono text-xs">${fields.phoneNumber || '-'}</td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center gap-4">
                                <button onclick="openEditModal('${id}', '${cleanName}', '${cleanFaculty}', '${cleanLevel}')" 
                                        class="text-indigo-600 hover:text-indigo-900 font-bold text-xs">تعديل</button>
                                <button onclick="deleteStudent('${id}')" 
                                        class="text-red-500 hover:text-red-800 font-bold text-xs">حذف</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingRow').innerHTML = `<td colspan="5" class="text-center p-10 text-red-500 font-bold">حدث خطأ في جلب البيانات!</td>`;
            }
        }

        // الحذف
        async function deleteStudent(id) {
            if (confirm('هل أنتِ متأكدة من حذف هذا الطالب؟')) {
                try {
                    const response = await fetch(DELETE_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: id })
                    });
                    if (response.ok) {
                        alert('تم الحذف بنجاح');
                        location.reload();
                    }
                } catch (e) { alert('خطأ في الحذف'); }
            }
        }

        // التعديل (فتح النافذة)
        function openEditModal(id, name, faculty, level) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-faculty').value = faculty;
            document.getElementById('edit-level').value = level;
            document.getElementById('editModal').classList.replace('hidden', 'flex');
        }

        function closeModal() {
            document.getElementById('editModal').classList.replace('flex', 'hidden');
        }

        // حفظ التعديلات
        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                id: document.getElementById('edit-id').value,
                fullName: document.getElementById('edit-name').value,
                faculty: document.getElementById('edit-faculty').value,
                academicYear: document.getElementById('edit-level').value
            };
            try {
                const response = await fetch(UPDATE_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    alert('تم التحديث!');
                    location.reload();
                }
            } catch (e) { alert('خطأ في التعديل'); }
        };

        // البحث
        function filterTable() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(input) ? "" : "none";
            });
        }

        window.onload = fetchStudents;
    </script>
</body>
</html>